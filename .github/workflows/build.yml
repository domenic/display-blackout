name: Build

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        platform: [x64, arm64]
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Validate version
        if: github.ref_type == 'tag'
        shell: pwsh
        run: |
          $tagVersion = "${{ github.ref_name }}" -replace '^v', ''

          # Extract version from manifest
          [xml]$manifest = Get-Content "DisplayBlackout/Package.appxmanifest"
          $manifestVersion = $manifest.Package.Identity.Version

          if ($tagVersion -ne $manifestVersion) {
            Write-Error "Version mismatch: tag is v$tagVersion but manifest has $manifestVersion"
            exit 1
          }

      - name: Set release publisher identity
        shell: pwsh
        run: |
          # The manifest uses a simple publisher for local development, but releases
          # need the full publisher identity with OID for sideloading compatibility
          $manifestPath = "DisplayBlackout/Package.appxmanifest"
          [xml]$manifest = Get-Content $manifestPath
          $manifest.Package.Identity.Publisher = "CN=Denicola Tech, OID.2.25.311729368913984317654407730594956997722=1"
          $manifest.Save($manifestPath)

      - name: Install ImageMagick
        shell: pwsh
        run: |
          choco install imagemagick -y
          refreshenv

      - name: Restore dependencies
        run: dotnet restore DisplayBlackout/DisplayBlackout.csproj

      - name: Build MSIX
        run: |
          dotnet publish DisplayBlackout/DisplayBlackout.csproj `
            -c Release `
            -p:Platform=${{ matrix.platform }} `
            -p:GenerateAppxPackageOnBuild=true `
            -p:AppxPackageDir=../packages/ `
            -p:UapAppxPackageBuildMode=SideloadOnly `
            -p:AppxBundle=Never `
            -p:AppxPackageSigningEnabled=false

      - name: Upload artifact
        if: github.ref_type == 'tag'
        uses: actions/upload-artifact@v5
        with:
          name: DisplayBlackout-${{ matrix.platform }}
          path: packages/**/DisplayBlackout*.msix

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'

    steps:
      - name: Download x64 artifact
        uses: actions/download-artifact@v5
        with:
          name: DisplayBlackout-x64
          path: artifacts/x64

      - name: Download arm64 artifact
        uses: actions/download-artifact@v5
        with:
          name: DisplayBlackout-arm64
          path: artifacts/arm64

      - name: Prepare release files
        id: prepare
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          mkdir -p release

          # Find and rename MSIX files
          find artifacts/x64 -name "DisplayBlackout*.msix" -exec cp {} "release/DisplayBlackout-${VERSION}-x64.msix" \;
          find artifacts/arm64 -name "DisplayBlackout*.msix" -exec cp {} "release/DisplayBlackout-${VERSION}-arm64.msix" \;

          ls -la release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release/*.msix
          generate_release_notes: true
          body: |
            ## Installation

            These packages are currently **unsigned**. To install:

            1. Download the `.msix` file for your architecture (x64 or arm64)
            1. Open PowerShell as Administrator
            1. Run: `Add-AppxPackage -Path "path\to\DisplayBlackout-x.x.x.x-arch.msix" -AllowUnsigned`

            I'm investigating code signing, but it seems expensive for Japan residents. See https://github.com/domenic/display-blackout/issues/6 for more discussion.
